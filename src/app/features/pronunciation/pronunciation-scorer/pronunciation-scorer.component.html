<div class="pronunciation-scorer-container">
  <mat-card class="main-card glass-surface elevate">
    <mat-card-header>
      <mat-card-title>Pronunciation Scorer</mat-card-title>
      <mat-card-subtitle>Record or upload audio to score your pronunciation</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Reference Text Input -->
      <section class="section">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Reference Text</mat-label>
          <textarea
            matInput
            placeholder="Enter the text you want to pronounce"
            [ngModel]="referenceText()"
            (ngModelChange)="referenceText.set($event)"
            rows="3"
            aria-label="Reference text to pronounce">
          </textarea>
          <mat-hint>This is the text you'll be pronouncing</mat-hint>
        </mat-form-field>

        <!-- Language Selection -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Language</mat-label>
          <mat-select
            [ngModel]="languageCode()"
            (ngModelChange)="languageCode.set($event)"
            aria-label="Language selection">
            @for (option of languageOptions; track option.code) {
              <mat-option [value]="option.code">{{ option.name }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </section>

      <div class="soft-divider" role="separator" aria-hidden="true"></div>

      <!-- Audio Recording Section -->
      <section class="section audio-section">
        <div class="recording-controls">
          @if (!isRecording()) {
            <button
              mat-raised-button
              color="primary"
              (click)="startRecording()"
              [disabled]="isLoading()"
              aria-label="Start recording">
              <mat-icon>mic</mat-icon>
              <span>Start Recording</span>
            </button>
          } @else {
            <button
              mat-raised-button
              color="warn"
              (click)="stopRecording()"
              aria-label="Stop recording">
              <span class="rec-dot" aria-hidden="true"></span>
              <mat-icon>stop</mat-icon>
              <span>Stop Recording</span>
            </button>
          }

          <span class="or-chip chip" aria-hidden="true">OR</span>

          <button
            mat-stroked-button
            color="primary"
            (click)="fileInput.click()"
            [disabled]="isLoading() || isRecording()"
            aria-label="Upload audio file">
            <mat-icon>upload</mat-icon>
            <span>Upload Audio</span>
          </button>
          <input
            #fileInput
            type="file"
            accept="audio/*"
            style="display: none"
            (change)="onFileSelected($event)">
        </div>

        <!-- Audio Player (if audio is recorded/uploaded) -->
        @if (audioUrl()) {
          <div class="audio-player glass-surface">
            <audio controls [src]="audioUrl()"></audio>
          </div>
        }
      </section>

      <!-- Error Message -->
      @if (errorMessage()) {
        <div class="error-message chip" role="alert">
          <mat-icon aria-hidden="true">error_outline</mat-icon>
          <span>{{ errorMessage() }}</span>
        </div>
      }

      <!-- Submit Button -->
      <section class="section submit-section">
        <button
          mat-raised-button
          color="primary"
          (click)="submitForScoring()"
          [disabled]="isLoading() || !audioBlob() || !referenceText() || isRecording()"
          aria-label="Score pronunciation">
          Score Pronunciation
        </button>
        <button
          mat-button
          (click)="resetForm()"
          [disabled]="isLoading() || isRecording()"
          aria-label="Reset form">
          Reset
        </button>
      </section>

      <!-- Loading Indicator -->
      @if (isLoading()) {
        <div class="loading-section">
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          <p>Analyzing pronunciation...</p>
        </div>
      }

      <div class="soft-divider" role="separator" aria-hidden="true"></div>

      <!-- Results Section -->
      @if (pronunciationEvaluation()) {
        <section class="section results-section">
          <mat-card class="glass-surface">
            <mat-card-header>
              <mat-card-title>Results</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <!-- Overall Score -->
              <div class="overall-score">
                <div class="score-ring" [style.background]="'conic-gradient(' + getScoreColor(getOverallScore()) + ' ' + ((getOverallScore()*100).toFixed(0)) + '%, rgba(2,6,23,0.08) ' + ((getOverallScore()*100).toFixed(0)) + '%, rgba(2,6,23,0.08) 100%)'">
                  <div class="score-ring__inner">
                    {{ (getOverallScore() * 100).toFixed(0) }}%
                  </div>
                </div>
                <p>Overall Score</p>
              </div>

              <!-- Transcribed Text -->
              <div class="transcribed-text glass-surface">
                <h3>Transcribed Text</h3>
                <p>{{ pronunciationEvaluation()!.transcript }}</p>
              </div>

              <!-- Word Details -->
              <div class="word-details">
                <h3>Word Analysis</h3>
                <div class="word-list">
                  @for (word of pronunciationEvaluation()!.words; track word.word) {
                    <div class="word-item elevate" [class.incorrect]="word.evaluation < 0.6">
                      <div class="word-row">
                        <span class="word chip">{{ word.word }}</span>
                        <span class="confidence">Score: {{ (word.evaluation * 100).toFixed(0) }}%</span>
                        <span class="confidence">Duration: {{ (word.endTime - word.startTime).toFixed(2) }}s</span>
                      </div>
                      <div class="phonemes">
                        @for (phoneme of word.phonemes; track phoneme.phoneme) {
                          <span class="phoneme" [style.color]="getScoreColor(phoneme.evaluation)">
                            {{ phoneme.phoneme }}: {{ (phoneme.evaluation * 100).toFixed(0) }}%
                          </span>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </section>
      }
    </mat-card-content>
  </mat-card>
</div>
